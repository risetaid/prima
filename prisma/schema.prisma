generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String               @id @default(uuid())
  stackId                   String               @unique @map("stack_id") // Stack Auth ID
  email                     String               @unique
  firstName                 String?              @map("first_name")
  lastName                  String?              @map("last_name")
  role                      UserRole             @default(MEMBER)
  isActive                  Boolean              @default(true) @map("is_active")
  isApproved                Boolean              @default(false) @map("is_approved")
  approvedAt                DateTime?            @map("approved_at")
  approvedBy                String?              @map("approved_by")
  createdAt                 DateTime             @default(now()) @map("created_at")
  updatedAt                 DateTime             @updatedAt @map("updated_at")
  approver                  User?                @relation("UserApprovals", fields: [approvedBy], references: [id])
  approvedUsers             User[]               @relation("UserApprovals")
  manualConfirmations       ManualConfirmation[]
  medicalRecords            MedicalRecord[]
  patientMedicationsCreated PatientMedication[]
  patientsManaged           Patient[]            @relation("VolunteerPatients")
  reminderSchedulesCreated  ReminderSchedule[]

  @@index([role])
  @@index([isActive])
  @@index([isApproved])
  @@index([role, isActive, isApproved])
  @@index([stackId, isApproved, isActive]) // Performance for auth queries
  @@map("users")
}

model Patient {
  id                    String               @id @default(uuid())
  name                  String
  phoneNumber           String               @map("phone_number")
  address               String?
  birthDate             DateTime?            @map("birth_date")
  diagnosisDate         DateTime?            @map("diagnosis_date")
  cancerStage           CancerStage?         @map("cancer_stage")
  assignedVolunteerId   String?              @map("assigned_volunteer_id")
  emergencyContactName  String?              @map("emergency_contact_name")
  emergencyContactPhone String?              @map("emergency_contact_phone")
  notes                 String?
  photoUrl              String?              @map("photo_url")
  isActive              Boolean              @default(true) @map("is_active")
  deletedAt             DateTime?            @map("deleted_at")
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  manualConfirmations   ManualConfirmation[]
  medicalRecords        MedicalRecord[]
  patientMedications    PatientMedication[]
  assignedVolunteer     User?                @relation("VolunteerPatients", fields: [assignedVolunteerId], references: [id])
  reminderLogs          ReminderLog[]
  reminderSchedules     ReminderSchedule[]

  @@index([isActive])
  @@index([assignedVolunteerId])
  @@index([assignedVolunteerId, isActive])
  @@index([phoneNumber])
  @@index([createdAt])
  @@map("patients")
}

model MedicalRecord {
  id             String            @id @default(uuid())
  patientId      String            @map("patient_id")
  recordType     MedicalRecordType @map("record_type")
  title          String
  description    String
  recordedDate   DateTime          @map("recorded_date")
  recordedBy     String            @map("recorded_by")
  createdAt      DateTime          @default(now()) @map("created_at")
  patient        Patient           @relation(fields: [patientId], references: [id])
  recordedByUser User              @relation(fields: [recordedBy], references: [id])

  @@map("medical_records")
}

model Medication {
  id                 String              @id @default(uuid())
  name               String
  createdAt          DateTime            @default(now()) @map("created_at")
  patientMedications PatientMedication[]

  @@map("medications")
}

model PatientMedication {
  id                String             @id @default(uuid())
  patientId         String             @map("patient_id")
  medicationId      String             @map("medication_id")
  dosage            String
  frequency         String
  instructions      String?
  startDate         DateTime           @map("start_date")
  endDate           DateTime?          @map("end_date")
  isActive          Boolean            @default(true) @map("is_active")
  createdBy         String             @map("created_by")
  createdAt         DateTime           @default(now()) @map("created_at")
  createdByUser     User               @relation(fields: [createdBy], references: [id])
  medication        Medication         @relation(fields: [medicationId], references: [id])
  patient           Patient            @relation(fields: [patientId], references: [id])
  reminderSchedules ReminderSchedule[]

  @@map("patient_medications")
}

model ReminderSchedule {
  id                  String               @id @default(uuid())
  patientId           String               @map("patient_id")
  medicationName      String               @map("medication_name")
  scheduledTime       String               @map("scheduled_time")
  frequency           Frequency            @default(CUSTOM)
  startDate           DateTime             @map("start_date")
  endDate             DateTime?            @map("end_date")
  customMessage       String?              @map("custom_message")
  isActive            Boolean              @default(true) @map("is_active")
  createdById         String               @map("created_by_id")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  manualConfirmations ManualConfirmation[]
  reminderLogs        ReminderLog[]
  createdByUser       User                 @relation(fields: [createdById], references: [id])
  patient             Patient              @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([isActive])
  @@index([patientId, isActive])
  @@index([startDate])
  @@index([endDate])
  @@index([createdAt, isActive]) // Performance for recent active reminders
  @@map("reminder_schedules")
}

model ReminderLog {
  id                  String               @id @default(uuid())
  reminderScheduleId  String?              @map("reminder_schedule_id")
  patientId           String               @map("patient_id")
  message             String
  phoneNumber         String               @map("phone_number")
  sentAt              DateTime             @map("sent_at")
  fonnteMessageId     String?              @map("fonnte_message_id")
  status              ReminderStatus       @default(PENDING)
  createdAt           DateTime             @default(now()) @map("created_at")
  manualConfirmations ManualConfirmation[]
  patient             Patient              @relation(fields: [patientId], references: [id])
  reminderSchedule    ReminderSchedule?    @relation(fields: [reminderScheduleId], references: [id])

  @@index([patientId])
  @@index([reminderScheduleId])
  @@index([status])
  @@index([sentAt])
  @@index([patientId, status])
  @@index([sentAt, status]) // Performance for cron job queries
  @@map("reminder_logs")
}


model ManualConfirmation {
  id                 String            @id @default(uuid())
  patientId          String            @map("patient_id")
  volunteerId        String            @map("volunteer_id")
  reminderScheduleId String?           @map("reminder_schedule_id")
  reminderLogId      String?           @map("reminder_log_id")
  visitDate          DateTime          @map("visit_date")
  visitTime          String            @map("visit_time")
  medicationsTaken   Boolean           @map("medications_taken")
  medicationsMissed  String[]          @map("medications_missed")
  patientCondition   PatientCondition  @map("patient_condition")
  symptomsReported   String[]          @map("symptoms_reported")
  notes              String?
  followUpNeeded     Boolean           @default(false) @map("follow_up_needed")
  followUpNotes      String?           @map("follow_up_notes")
  confirmedAt        DateTime          @default(now()) @map("confirmed_at")
  patient            Patient           @relation(fields: [patientId], references: [id])
  reminderLog        ReminderLog?      @relation(fields: [reminderLogId], references: [id])
  reminderSchedule   ReminderSchedule? @relation(fields: [reminderScheduleId], references: [id])
  volunteer          User              @relation(fields: [volunteerId], references: [id])

  @@index([patientId])
  @@index([volunteerId])
  @@index([reminderScheduleId])
  @@index([reminderLogId])
  @@index([visitDate])
  @@index([patientId, visitDate])
  @@index([confirmedAt, patientId]) // Performance for completion tracking
  @@map("manual_confirmations")
}






model WhatsAppTemplate {
  id           String           @id @default(uuid())
  templateName String           @unique @map("template_name")
  templateText String           @map("template_text")
  variables    String[]
  category     TemplateCategory
  isActive     Boolean          @default(true) @map("is_active")
  createdBy    String           @map("created_by")
  createdAt    DateTime         @default(now()) @map("created_at")

  @@map("whatsapp_templates")
}



enum UserRole {
  ADMIN
  MEMBER
}

enum CancerStage {
  I
  II
  III
  IV
}

enum MedicalRecordType {
  DIAGNOSIS
  TREATMENT
  PROGRESS
}

enum Frequency {
  CUSTOM
  CUSTOM_RECURRENCE
}

enum ReminderStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum PatientCondition {
  GOOD
  FAIR
  POOR
}

enum TemplateCategory {
  REMINDER
  APPOINTMENT
  EDUCATIONAL
}
